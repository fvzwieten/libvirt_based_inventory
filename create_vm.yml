- name: Create a libvirt VM
  hosts: all
  gather_facts: False
  become: True
  tasks:
  - name: Install VM
    ansible.builtin.command:
      argv:
        - /usr/bin/virt-install 
        - --name {{ vm_name }}
        - --memory {{ vm_amount_memory_gb }}
        - --vcpus {{ vm_amount_vcpu }}
        - --disk pool=default,size={{ vm_amount_disk_gb }},format=qcow2,backing_store=/var/lib/libvirt/images/rhel-{{ rhel_version }}-x86_64-kvm.qcow2,backing_format=qcow2
        - --os-variant {{ vm_variant }}
        - --import
        - --network network={{ vm_subnet }},model=virtio
        - --graphics vnc
        - --serial pty
        - --console pty
        - --machine pc-q35-9.1
        - --cloud-init user-data=/tmp/user-data.yml,network-config=/tmp/network-config.yml
